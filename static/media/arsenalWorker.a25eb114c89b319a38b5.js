const CHUNK_LIMIT=20;self.onmessage=function(e){const{command:t,params:l}=e.data;"start"===t?computeRates(l):"cancel"===t&&(cancelled=!0)};let cancelled=!1;function buildBinomial(e,t){let l=Array.from({length:e+1},()=>new Float32Array(e+1).fill(0));l[0][0]=1;for(let i=1;i<=e;i++)for(let e=0;e<i;e++)0!==l[i-1][e]&&(l[i][e]+=l[i-1][e]*(1-t),l[i][e+1]+=l[i-1][e]*t);return l}const sixStarDist=buildBinomial(10,.04)[10],featDist=buildBinomial(10,.25),nonfeatDist=buildBinomial(10,.125);function computeRates(e){let{maxPulls:t,pullsUntil6:l,target6Type:i,pulled6:n,target6:a,pullsOnBanner:s}=e;const o=4*(a+1);cancelled=!1;let f=new Float64Array(o).fill(0),r=new Float64Array(o).fill(0);function c(e,t){return e*(a+1)+t}function u(e){let t=e,l=t%(a+1);return t=Math.floor(t/(a+1)),{p6:t,k:l}}f[c(4-l,n)]=1;let d=0,p=0,m=0,D=1;const M=()=>{if(cancelled)return void self.postMessage({type:"done",cancelled:cancelled});const e=[];for(;e.length<20&&D<=t;){r.fill(0);let t=s+D;for(let e=0;e<o;e++){const l=f[e];if(l<1e-15)continue;let{p6:n,k:s}=u(e);if(8===t&&"Featured"===i&&0===s)for(let e=1;e<=10;e++){let t=1===e?sixStarDist[0]+sixStarDist[1]:sixStarDist[e];for(let i=1;i<=e;i++){let n=1===i?featDist[e][0]+featDist[e][1]:featDist[e][i],o=Math.min(s+i,a);r[c(0,o)]+=l*t*n}d+=e*l*t,p+=(10-e)*l*t*.15,m+=(10-e-.15*(10-e))*l*t}else if(3===n)for(let e=1;e<=10;e++){let t=1===e?sixStarDist[0]+sixStarDist[1]:sixStarDist[e];if("Featured"===i){for(let i=1;i<=e;i++){let n=featDist[e][i],o=Math.min(s+i,a);r[c(0,o)]+=l*t*n}r[c(0,s)]+=l*t*featDist[e][0]}else if("Specific NonFeatured"===i){for(let i=1;i<=e;i++){let n=nonfeatDist[e][i],o=Math.min(s+i,a);r[c(0,o)]+=l*t*n}r[c(0,s)]+=l*t*nonfeatDist[e][0]}else if("Any"===i){let i=Math.min(s+e,a);r[c(0,i)]+=l*t}d+=e*l*t,p+=(10-e)*l*t*.15,m+=(10-e-.15*(10-e))*l*t}else for(let e=0;e<=10;e++){let t=sixStarDist[e],o=e>0?0:n+1;if("Featured"===i)for(let i=0;i<=e;i++){let n=featDist[e][i],f=Math.min(s+i,a);r[c(o,f)]+=l*t*n}else if("Specific NonFeatured"===i)for(let i=0;i<=e;i++){let n=nonfeatDist[e][i],f=Math.min(s+i,a);r[c(o,f)]+=l*t*n}else if("Any"===i){let i=Math.min(s+e,a);r[c(o,i)]+=l*t}if(d+=e*l*t,0===e){let i=1.5+Math.pow(.85,10);p+=i*l*t,m+=(10-e-i)*l*t}else{let i=.15*(10-e);p+=i*l*t,m+=(10-e-i)*l*t}}}if(t>=10&&(t-2)%8===0)if((t-2)%16===0){if("Featured"===i||"Any"===i){[f,r]=[r,f],r.fill(0);for(let e=0;e<o;e++){const t=f[e];if(t<1e-15)continue;let{p6:l,k:i}=u(e);const n=Math.min(i+1,a);r[c(l,n)]+=t}}d++}else{if("Specific NonFeatured"===i||"Any"===i){[f,r]=[r,f],r.fill(0);for(let e=0;e<o;e++){const t=f[e];if(t<1e-15)continue;let{p6:l,k:i}=u(e);const n=Math.min(i+1,a);r[c(l,n)]+=t}}d++}let l=0,n=new Float64Array(a+1).fill(0);for(let e=0;e<o;e++){const t=r[e];if(l+=t,t<1e-15)continue;n[e%(a+1)]+=t}let M=new Float64Array(a+1).fill(0);M[a]=n[a];for(let e=a-1;e>0;e--)M[e]=n[e]+M[e+1];if(e.push({pull:D,probAtLeastK:[...M],e6:d,e5:p,e4:m}),Math.abs(l-1)>1e-12)for(let e=0;e<o;e++)r[e]/=l;[f,r]=[r,f],D++}self.postMessage({type:"results",results:e}),D>=t&&self.postMessage({type:"done",cancelled:cancelled}),setTimeout(M,0)};M()}