const CHUNK_LIMIT=20;self.onmessage=function(e){const{command:t,params:l}=e.data;"start"===t?computeRates(l):"cancel"===t&&(cancelled=!0)};let cancelled=!1,free30rates=null;function computeFree30(){if(free30rates)return free30rates;let e=[new Float32Array(7).fill(0),new Float32Array(7).fill(0)];e[0][0]=1,free30rates={e6:0,e5:0,e4:0};for(let t=0;t<9;t++){let l=(t+1)%2;e[l].fill(0);for(let n=0;n<=6;n++){let r=e[t%2][n];e[l][Math.min(n+1,6)]+=.004*r,e[l][n]+=.996*r,free30rates.e6+=.008*r,free30rates.e5+=.08*r,free30rates.e4+=.912*r}}e[0].fill(0);for(let t=0;t<=6;t++){let l=e[1][t];e[0][Math.min(t+1,6)]+=.004*l,e[0][t]+=.996*l,free30rates.e6+=.008*l,free30rates.e5+=.992*l}return free30rates.dp=[...e[0]],free30rates}function computeRates(e){let{maxPulls:t,pullsUntil6:l,pullsUntil5:n,pulled6:r,target6:a,pullsOnBanner:o}=e;const f=800*(a+1);cancelled=!1;let s=new Float32Array(f).fill(0),c=new Float32Array(f).fill(0);function i(e,t,l){return(10*e+t)*(a+1)+l}function u(e){let t=e,l=t%(a+1);t=Math.floor(t/(a+1));let n=t%10;return t=Math.floor(t/10),{p6:t,p5:n,k:l}}s[i(80-l,10-n,r)]=1;let p=0,d=0,m=0,M=1;const h=()=>{if(cancelled)return void self.postMessage({type:"done",cancelled:cancelled});const e=[];for(;e.length<20&&M<=t;){c.fill(0);let t=o+M;for(let e=0;e<f;e++){const l=s[e];if(l<1e-15)continue;let n,{p6:r,p5:o,k:f}=u(e);if(n=r<65?.008:r<79?.008+.05*(r-64):1,120===t&&0===f){let e=Math.min(f+1,a);c[i(0,0,e)]+=l,p+=l;continue}{let e=Math.min(f+1,a);c[i(0,0,e)]+=l*n*.5,c[i(0,0,f)]+=l*n*.5}let M=Math.min(9===o?1:.08,1-n);c[i(r+1,0,f)]+=l*M;let h=1-n-M;c[i(r+1,o+1,f)]+=l*h,p+=l*n,d+=l*M,m+=l*h}if(30===t){[s,c]=[c,s],c.fill(0);let e=computeFree30();for(let t=0;t<f;t++){const l=s[t];if(l<1e-15)continue;let{p6:n,p5:r,k:o}=u(t);for(let t=0;t<e.dp.length;t++){const f=Math.min(o+t,a);c[i(n,r,f)]+=l*e.dp[t]}p+=l*e.e6,d+=l*e.e5,m+=l*e.e4}}if(t%240===0){[s,c]=[c,s],c.fill(0);for(let e=0;e<f;e++){const t=s[e];if(t<1e-15)continue;let{p6:l,p5:n,k:r}=u(e);const o=Math.min(r+1,a);c[i(l,n,o)]+=t}p++}let l=new Float32Array(a+1).fill(0);for(let e=0;e<f;e++){const t=c[e];if(t<1e-15)continue;l[e%(a+1)]+=t}let n=new Float32Array(a+1).fill(0);n[a]=l[a];for(let e=a-1;e>0;e--)n[e]=l[e]+n[e+1];e.push({pull:M,probAtLeastK:[...n],e6:p,e5:d,e4:m}),[s,c]=[c,s],M++}self.postMessage({type:"results",results:e}),M>=t&&self.postMessage({type:"done",cancelled:cancelled}),setTimeout(h,0)};h()}